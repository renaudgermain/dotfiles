#!/bin/sh -ex

# create rcog user in group wheel
# echo 'https://openbsd.mirror.netelligent.ca/pub/OpenBSD' > /etc/installurl
# pkg_add git
# git clone --bare https://github.com/renaudgermain/dotfiles.git .git
# git config core.bare false
# git reset --hard

case $(whoami):$(hostname) in
    root:alpha)
        pacman -Syu xorg-xrandr xorg-xdpyinfo mesa-demos alsa-utils git ratpoison \
               mpv rxvt-unicode xorg-{xserver,xsetver,xsetroot,xset,xinit,xdm}
        echo "TODO add rcog to groups audio, video"
        echo "TODO replace grub by syslinux w/ autoselect"
        echo "doc	/home/rcog/doc	9p	trans=virtio,version=9p2000.L	0	0" >> /etc/fstab
        echo "media	/home/rcog/media	9p	trans=virtio,version=9p2000.L	0	0" >> /etc/fstab
        mkdir /home/rcog/{doc,media}
        systemctl enable dhcpcd
        systemctl enable xdm.service
        ;;
    rcog:alpha)
        ln -s .xinitrc ~/.xsession
        ;;
    root:delta)
        apt-get install -y virt-viewer
        ;;
    root:gulf)
        # pkg_info -mz
        pkg_add ImageMagick abook emacs--no_x11%emacs eyeD3 feh firefox ghc gnupg--%gnupg2 go mediainfo \
                mpg321 mpv mupdf mutt--gpgme-sasl rxvt-unicode sshfs-fuse surfraw unzip urlview
        # TODO echo '10.0.2.2        alpha' >> /etc/hosts
        echo '10.0.2.2        delta' >> /etc/hosts
        echo 'dhcp' > /etc/hostname.re0
        mkdir /home/rcog/{doc,media}
        cat <<EOF > /etc/rc.local
/usr/local/bin/sshfs -o ssh_command='ssh -i /home/rcog/.ssh/id_rsa' rcog@delta:/home/rcog/media /home/rcog/media
/usr/local/bin/sshfs -o ssh_command='ssh -i /home/rcog/.ssh/id_rsa' rcog@delta:/home/rcog/doc   /home/rcog/doc
EOF
        rcctl set sndiod flags -mplay
        echo 'export PS1="\[[31m\][\u@\h \W]\\$ \[[0m\]"' >> /root/.profile
        ;;
    rcog:gulf)
        umask 077
        mkdir $HOME/.abook
        ssh-keygen
        echo "TODO upload ~/.ssh/id_rsa.pub to github.com"
        git remote set-url origin git@github.com:renaudgermain/dotfiles.git
        echo 'github.com,192.30.253.113 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==' >> $HOME/.ssh/known_hosts
        echo 'delta,10.0.2.2 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFg1cZ+4lVzMNlAGNLarVDk3QNPpK90bh/W/aLPW9DrWdLfrXbwkyu/CXP3SxmxHRUnj+LjWCcGuS7w+0IOIcZY=' >> $HOME/.ssh/known_hosts
        echo "TODO copy id_rsa.pub to delta:~/.ssh/authorized_keys"
        curl -L 'https://docs.google.com/uc?id=0B3X9GlR6EmbnSy1JdFlHdUYyaGs&export=download' \
             --output $HOME/usr/bin/gdrive-openbsd-x64
        test $(sha1 -q $HOME/usr/bin/gdrive-openbsd-x64) = 54be1d38b9014c6a8de5d71233cd6f208c27ac1c
        chmod 700 $HOME/usr/bin/gdrive-openbsd-x64
        ln -sf gdrive-openbsd-x64 $HOME/usr/bin/gdrive
        gdrive about # visit url, get code, paste code
        gdrive download 1WNJ7QCudjB6KNlMp0WgLrixYj6rPDx-e # .todo.org
        gdrive download 1SOIDcpLROYoHEjnMLZ0vrIfTpYD2KUK1 --path doc/RecettesCuisine.org
        gdrive download 1015zVq55bI7ByjQAfaRfMRh0wXyeq4VS --path doc/notes.org
        gdrive download 1EZTLgp8398ZIGhQlHq3_safi9er5TvEh --path .abook/addressbook
        crontab - <<EOF
@daily    $HOME/usr/bin/gdrive update 1SOIDcpLROYoHEjnMLZ0vrIfTpYD2KUK1 doc/RecettesCuisine.org
@daily    $HOME/usr/bin/gdrive update 1WNJ7QCudjB6KNlMp0WgLrixYj6rPDx-e .todo.org
5 0 * * * $HOME/usr/bin/gdrive update 1015zVq55bI7ByjQAfaRfMRh0wXyeq4VS doc/notes.org
9 0 * * * $HOME/usr/bin/gdrive update 1EZTLgp8398ZIGhQlHq3_safi9er5TvEh .abook/addressbook
EOF
        scp delta:~/.wallpaper.jpg .
        gpg2 --receive-keys 80BF439C # FIXME unneeded?
        ssh -t delta gpg --armor --export-secret-keys 80BF439C | gpg2 --import # FIXME make ssh forward stderr, have gpg2 accept stdin
        echo "trust\n5\ny\n" | gpg2 --command-fd 0 --edit-key 80BF439C
        echo 'default-key 7A6335617EADD4DA5DAEF9C6564FFC1780BF439C' >> $HOME/.gnupg/gpg.conf
        mkdir -p $HOME/.cache/mutt
        read p?'mutt password:' # FIXME secure input
        echo "set imap_pass=\"$p\"\nset smtp_pass=\"$p\"" | gpg2 --encrypt --recipient 80BF439C > ~/.cache/mutt/passwords.gpg
        # might require restarting gpg-agent
        echo "TODO browser.tabs.loadDivertedInBackground = true, uBlock origin, tridactyl"
        git clone https://github.com/chneukirchen/nq.git /tmp/nq
        make -C /tmp/nq PREFIX=~/usr install
        echo "TODO (from delta) ssh rcog@127.0.0.1 -p 7922 cat ~/.ssh/id_rsa.pub >> .ssh/authorized_keys
        ;;
esac
